<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Proxy Control Panel</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background: #1e1e1e; color: #f0f0f0; margin: 0; padding: 20px;}
  h1 { text-align: center; }
  #login, #panel { max-width: 600px; margin: 0 auto; background: #2b2b2b; padding: 20px; border-radius: 8px; }
  input, button, select { display: block; width: 100%; padding: 10px; margin: 10px 0; border-radius: 4px; border: none; }
  button { background: #4caf50; color: white; cursor: pointer; }
  button:hover { background: #45a049; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #444; padding: 8px; text-align: left; }
  th { background: #333; }
</style>
</head>
<body>

<h1>Proxy Control Panel</h1>

<div id="login">
  <h2>Login</h2>
  <input type="text" id="username" placeholder="Username" />
  <input type="password" id="password" placeholder="Password" />
  <button onclick="login()">Login</button>
  <p id="login-status"></p>
</div>

<div id="panel" style="display:none;">
  <h2>Welcome, <span id="user-name"></span> (<span id="user-role"></span>)</h2>

  <h3>Online Users</h3>
  <table>
    <thead>
      <tr><th>Username</th><th>Role</th><th>Version</th><th>Actions</th></tr>
    </thead>
    <tbody id="online-users"></tbody>
  </table>

  <div id="owner-controls" style="display:none;">
    <h3>Owner Controls</h3>
    <input type="text" id="new-username" placeholder="New Username" />
    <input type="password" id="new-password" placeholder="New Password" />
    <select id="new-role">
      <option value="member">Member</option>
      <option value="moderator">Moderator</option>
    </select>
    <button onclick="createUser()">Create User</button>

    <button onclick="toggleKillSwitch(true)">Enable Kill Switch</button>
    <button onclick="toggleKillSwitch(false)">Disable Kill Switch</button>
  </div>
</div>

<script>
let socket;
let jwtToken;
let currentUserRole;

async function login() {
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  const res = await fetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password })
  });
  const data = await res.json();
  if(data.token) {
    jwtToken = data.token;
    currentUserRole = data.role;
    document.getElementById('login').style.display = 'none';
    document.getElementById('panel').style.display = 'block';
    document.getElementById('user-name').innerText = username;
    document.getElementById('user-role').innerText = data.role;
    if(currentUserRole === 'owner') document.getElementById('owner-controls').style.display = 'block';
    connectSocket();
    updateOnlineUsers();
  } else {
    document.getElementById('login-status').innerText = data.error || 'Login failed';
  }
}

function connectSocket() {
  socket = io({ auth: { token: jwtToken, version: '1.0' } });
  socket.on('connect', ()=>console.log('Socket connected'));
  socket.on('server:online-update', data => renderOnlineUsers(data));
  socket.on('server:kill-switch', data => alert('Kill switch ' + (data.enabled?'enabled':'disabled')));
  socket.on('server:command', data => console.log('Command received:', data));
}

async function updateOnlineUsers() {
  const res = await fetch('/api/online', {
    headers: { 'Authorization': 'Bearer ' + jwtToken }
  });
  const users = await res.json();
  renderOnlineUsers(users);
  setTimeout(updateOnlineUsers, 2000);
}

function renderOnlineUsers(users) {
  const tbody = document.getElementById('online-users');
  tbody.innerHTML = '';
  users.forEach(u=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${u.username}</td>
      <td>${u.role}</td>
      <td>${u.version}</td>
      <td>
        ${currentUserRole==='owner'||currentUserRole==='moderator' ? `
          <button onclick='sendCommand("${u.socketId}","timeout")'>Timeout</button>
          <button onclick='sendCommand("${u.socketId}","kick")'>Kick</button>
        `:''}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function createUser() {
  const username = document.getElementById('new-username').value;
  const password = document.getElementById('new-password').value;
  const role = document.getElementById('new-role').value;
  const res = await fetch('/api/users', {
    method:'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer '+jwtToken },
    body: JSON.stringify({ username, password, role })
  });
  const data = await res.json();
  if(data.ok) alert('User created');
  else alert(data.error);
}

function sendCommand(socketId, command) {
  socket.emit('server:command', { targetSocketId: socketId, command, data:{} });
}

function toggleKillSwitch(enable) {
  fetch('/api/kill-switch', {
    method:'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer '+jwtToken },
    body: JSON.stringify({ enable })
  }).then(r=>r.json()).then(d=>alert('Kill switch ' + (d.killSwitchEnabled?'enabled':'disabled')));
}
</script>

</body>
</html>
